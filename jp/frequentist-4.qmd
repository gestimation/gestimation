---
format:
  html:
    toc: true
---
<style>
body {
  margin: 0;
  background: #ffffff;
  color: #2b1f1a;
  font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
  font-size: 18px;
  line-height: 1.55;
}

h1, h2, h3 {
  font-family: "Georgia", "Times New Roman", serif;
  color: #3a2a22;
  font-weight: 600;
}

h3 {
  margin-top: 2.4rem;
}

a {
  color: #8b4a24;
  text-decoration: none;
}
a:hover {
  color: #6f3718;
  text-decoration: underline;
}

.navbar {
  background: #ffffff !important;
  border-bottom: 1px solid #e6e0da;
  margin-bottom: 0 !important;
}
.navbar .navbar-brand,
.navbar .navbar-nav > li > a {
  color: #3a2a22 !important;
  border-bottom: 2px solid transparent;
  padding-bottom: 2px;
}
.navbar .navbar-nav > li > a:hover {
  border-bottom-color: #8b4a24;
}

.hero-text {
  padding: 1.5rem 0;
  color: #3a2a22;
}

.project-card {
  border: 1px solid #e6e0da;
  padding: 1.3rem 1.5rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  background: #ffffff;
  border-radius: 6px;
  margin-bottom: 1.5rem;
}

.about-section {
  border: 1px solid #e6e0da;
  padding: 1.5rem;
  border-radius: 0;
  background: #ffffff;
  margin-top: 2.5rem;
}

.about-section::after {
  content: "";
  display: block;
  clear: both;
}

.author-photo {
  float: left;
  margin-right: 1rem;
  border-radius: 50%;
}

.btn-link {
  display: inline-block;
  border: 1px solid #8b4a24;
  color: #8b4a24;
  padding: 0.4rem 0.9rem;
  font-size: 0.9rem;
  border-radius: 3px;
}
.btn-link:hover {
  background: #8b4a24;
  color: #ffffff;
}

.content-narrow {
  max-width: 1000px;
  margin: 0 auto;
  padding: 1.8rem 1.2rem 2.5rem;
}

.hero-header {
  margin-left: calc(50% - 50vw);
  margin-right: calc(50% - 50vw);
}

.hero-header-img {
  width: 100vw;
  height: min(400px, 45vh);
  object-fit: cover;
  object-position: 50% 40%;
  display: block;
}

.dialogue p {
  line-height: 1.7;
}
.dialogue .voice-father p {
  color: #7a3e1a !important;
}
.dialogue .voice-daughter p {
  color: #234f7c !important;
}
.dialogue .voice-daughter,
.dialogue .voice-father {
  margin-bottom: 0.4rem;
}

.serif-text p {
  font-family: "Georgia", "Times New Roman", serif;
}
.serif-block p {
  font-family: "Georgia", "Times New Roman", serif;
  font-size: 0.9em;  line-height: 1.6;
}
</style>

::: hero-header
![](../image/father-daughter.png){.hero-header-img}
:::
# Story and Quiz − Frequentist thinking IV

::: serif-block
　　　　　　　　　　　　Keywords: OS/PFS/DFS/response, survival/competing-risk, clinical trial
:::

------------------------------------------------------------------------

### お父さん、その95%信頼区間って本当に95%なの？

::::::::::::::::::::::::::::::::: dialogue
::: voice-father
父「コーヒー淹れたよ」
:::

::: voice-daughter
私「ありがとう。あのさ、ちょっと気になったんだけど。“95%信頼区間（confidence interval）です”って、みんな当たり前のようにいうけど、ほんとに95%も当たってるの？」
:::

::: voice-father
父「ん？そりゃ当たってるよ。仮定した確率分布が正しければね。証明もできるよ」
:::

::: voice-daughter
私「ふーん。じゃあ正しいんだ。ほとんど間違わないってすごいね」
:::

::: voice-father
父「ああ、言葉だけで95%っていわれても実感がわかないよね。じゃあ今日はRでハザード比の95%信頼区間の被覆確率（coverage）を出してみようか。シミュレーションでね」
:::

::: voice-daughter
私「coverage？つまり、本当に100回に95回当たるかどうか？」
:::

::: voice-father
父「そう。信頼区間が真値を当てる頻度を、シミュレーションデータで数えるんだ。頻度論の約束が、どの程度守られているかを確かめる仮想実験だよ。前提条件を整理しよう。2群比較の生存曲線を比べたいんだよね」
:::

::: voice-daughter
私「ストーマあり群とストーマなし群ね」
:::

::: voice-father
父「そうだね、ストーマあり群とストーマなし群のOSを比べよう。真のハザード比は1.5、つまりストーマあり群の方が寿命が1.5倍短い。ハザード比の95%信頼区間は、1000回シミュレーションしたら、1.5を約950回は含んでいるはず」
:::

::: voice-daughter
私「これがcoverageね」
:::

::: voice-father
父「生存曲線の形は指数分布で決める。途中で追跡できなかった患者は打ち切り扱いになるけど、それも指数分布で発生させる。この設定だと、Coxモデルの仮定はすべて正しい。だから理論的にcoverageは95%になるはず」
:::

::: voice-daughter
私「じゃあ、その通りになるかどうか、Rで確かめればいいんだね。」
:::
:::::::::::::::::::::::::::::::::


::: {.callout-note title="coxph()を用いた95%信頼区間のシミュレーション"}
ハザード比を推定する方法はいくつかありますが、もっともポピュラーなのは`survival`パッケージの`coxph()`です。以前のデモで、関数generate_data(hr1, hr2)を用いて、ストーマの有無やOSのデータを生成しました。今回は同じデータにCox回帰を当てはめ、ストーマあり群とストーマなし群のハザード比を計算してみます。この関数では、死亡ハザード比の真値はhr2という引数で指定できます。

```{r echo=FALSE, warning=FALSE}
generate_data <- function(n=200, hr1, hr2) {
  stoma <- rbinom(n, size = 1, prob = 0.4)
  sex <- rbinom(n, size = 1, prob = 0.5)
  age <- rnorm(n, mean = 65 + 3 * stoma, sd = 8)
  hazard_relapse   <- ifelse(stoma == 1, hr1*0.10, 0.10) # 再発のハザード（大きいほど早く起こる）
  hazard_death     <- ifelse(stoma == 1, hr2*0.10, 0.10) # 死亡のハザード（大きいほど早く起こる）
  hazard_censoring <- 0.05                               # 打ち切りハザード（群に依存しない）
  
  t_relapse   <- rexp(n, rate = hazard_relapse)   # 再発までの潜在時間
  t_death     <- rexp(n, rate = hazard_death)     # 死亡までの潜在時間
  t_censoring <- rexp(n, rate = hazard_censoring) # 打ち切りまでの潜在時間
  
  ## --- 全生存期間（OS） ----------------------------------------
  time_os   <- pmin(t_death, t_censoring)
  status_os <- as.integer(t_death <= t_censoring)  # 1 = 死亡, 0 = 打ち切り
  
  ## --- 無再発存期間（RFS） -------------------------------------
  time_rfs <- pmin(t_relapse, t_death, t_censoring)
  
  status_rfs <- integer(n)
  status_rfs[time_rfs == t_relapse & time_rfs < t_censoring] <- 1 # 再発
  status_rfs[time_rfs == t_death & time_rfs < t_censoring] <- 1   # 死亡
  
  ## --- 累積再発率（CIR） + 競合リスク --------------------------
  time_cir <- pmin(t_relapse, t_death, t_censoring)
  
  status_cir <- integer(n)
  status_cir[time_cir == t_relapse & time_cir < t_censoring] <- 1 # イベント1: 再発
  status_cir[time_cir == t_death & time_cir < t_censoring] <- 2   # イベント2: 競合リスクとしての死亡
  
  ## --- データフレームにまとめる --------------------------------
  dat <- data.frame(
    id         = 1:n,
    sex        = factor(sex, levels = c(0, 1), labels = c("WOMAN", "MAN")),
    age        = age,
    stoma      = factor(stoma, levels = c(0, 1),
                        labels = c("WITHOUT STOMA", "WITH STOMA")),
    time_os    = time_os,
    status_os  = status_os,
    time_rfs   = time_rfs,
    status_rfs = status_rfs,
    time_cir   = time_cir,
    status_cir = status_cir
  )
}
```

```{r warning=FALSE}
# install.packages("survival") #インストールが必要なら実行
calculate_coverage <- function(model=c("coxph","finegray"), n, hr1, hr2, hr_true) {
  set.seed(46)
  replications=1000
  covered <- numeric(replications)

  for (r in seq_len(replications)) {
    dat <- generate_data(n, hr1, hr2)
    if (identical(model, "coxph")) {
      fit <- coxph(Surv(time_os, status_os) ~ stoma, data = dat)
    } else if (identical(model, "finegray")) {
      dat$fstatus_cir <- factor(dat$status_cir,
                                levels = 0:2,
                                labels = c("censor",
                                           "relapse",
                                           "death"))
      fgdat <- finegray(Surv(time_cir, fstatus_cir) ~ ., data=dat)
      fit <- coxph(Surv(fgstart, fgstop, fgstatus) ~ stoma, weight=fgwt, cluster=id, data=fgdat)
    }
    confidence_interval <- confint(fit)
    covered[r] <- as.integer(confidence_interval[1] <= log(hr_true) && log(hr_true) <= confidence_interval[2])
  }
  coverage <- mean(covered)
  return(coverage)
}

library(survival)
coverage_200 <- calculate_coverage(model="coxph", n=200, hr1=2, hr2=1.5, hr_true=1.5)
print(coverage_200)
```
:::

::::::::::::::::::::::::::::::::: dialogue
::: voice-daughter
私「だいたいcoverageが95%になるっていのはわかった。でも結局、“95%信頼区間”ってどう理解すればいいの？」
:::

::: voice-father
お父さん「教科書的にいうとね。同じようなデータを何度も集めて、毎回95%信頼区間を作ったとき、“真の値を含む区間”の割合が0.95になるように設計された指標なんだ。これを"in the long run"の性能って言ったりする。でも、概念的に理解するよりも、シミュレーションを行った方がわかりやすいと思って」
:::

::: voice-daughter
私「1回の研究で“この区間が当たっている確率が95%”って意味じゃないんだね」
:::

::: voice-father
お父さん「そうだね」
:::

::: voice-daughter
私「じゃあ、人数が100人だったどうなるの？人数が減ったら当たりにくくはならないの？」
:::

::: voice-father
お父さん「理論的には当たりにくくなったりはしないよ。95%信頼区間の被覆確率はサンプルサイズによらず95%になるはず。n=100、200、400、800のシミュレーション結果をみてみようか」
:::
:::::::::::::::::::::::::::::::::

```{r warning=FALSE}
coverage_100 <- calculate_coverage(model="coxph", n=100, hr1=2, hr2=1.5, hr_true=1.5)
coverage_400 <- calculate_coverage(model="coxph", n=400, hr1=2, hr2=1.5, hr_true=1.5)
coverage_800 <- calculate_coverage(model="coxph", n=800, hr1=2, hr2=1.5, hr_true=1.5)
print(coverage_100)
print(coverage_200)
print(coverage_400)
print(coverage_800)
```

::::::::::::::::::::::::::::::::: dialogue
::: voice-daughter
私「ほんとだ、だいたい95%。じゃあ調査人数は何人でもいいってことだ」
:::

::: voice-father
お父さん「ん？どういう意味？」
:::

::: voice-daughter
私「がんサバイバー何人に調査票を送るかってこと。だって信頼区間の性能は人数によらないんでしょ」
:::

::: voice-father
お父さん「あ、ごめん、誤解があったね。サンプルサイズが小さくなると、coverageは同じでも、信頼区間幅が広くなる。今のところ、何人に調査するつもりだった？」
:::

::: voice-daughter
私「100人から調査票戻ってきたら上出来かなって思ってるけど」
:::

::: voice-father
お父さん「やっぱり必要サンプルサイズは計算してなかったか。がんを手術した後の復職率を推定したいってことでいいの？それなら100人でギリギリだと思う」
:::

::: voice-daughter
私「いや？前にお父さんにPECOを教えてもらったよね。あれから上司と相談して、ストーマを造設した患者の復職状況を造設しなかった患者と比べることにしたの」
:::

::: voice-father
お父さん「そうなんだ。そうすると計算が違ってくる。100人だと足りないはず」
:::

::: voice-daughter
私「へ？なんでそんなことわかるのよ。100人に協力してもらうのってたいへんなのよ」
:::

::: voice-father
お父さん「どれだけサンプルサイズが必要なのかについて、統計学的な根拠に基づいて見積もる方法があるんだよ。この表をみてみて。ある書籍から借りてきたものなんだけど（Machin, et al. 2022）」
:::

表1. 割合の推定において指定した 95%信頼区間幅のため必要なサンプルサイズ

| 割合 π | 0.05 | 0.10 | 0.15 | 0.20 |
|--------|-----:|-----:|-----:|-----:|
| 0.01   |  108 |   43 |   25 |   17 |
| 0.02   |  152 |   52 |   29 |   19 |
| 0.03   |  201 |   61 |   33 |   21 |
| 0.04   |  252 |   72 |   37 |   23 |
| 0.05   |  304 |   83 |   41 |   25 |
| 0.06   |  356 |   95 |   46 |   28 |
| 0.07   |  407 |  107 |   50 |   30 |
| 0.08   |  458 |  118 |   55 |   32 |
| 0.09   |  508 |  130 |   60 |   35 |
| 0.10   |  554 |  139 |   62 |   35 |
| 0.11   |  604 |  153 |   69 |   40 |
| 0.12   |  651 |  164 |   74 |   42 |
| 0.13   |  696 |  175 |   78 |   44 |
| 0.14   |  741 |  186 |   83 |   47 |
| 0.15   |  784 |  196 |   87 |   49 |
| 0.16   |  826 |  206 |   92 |   51 |
| 0.17   |  867 |  216 |   96 |   54 |
| 0.18   |  907 |  226 |  100 |   56 |
| 0.19   |  945 |  236 |  104 |   58 |
| 0.20   |  982 |  245 |  108 |   60 |
| 0.25   | 1150 |  286 |  126 |   70 |
| 0.30   | 1288 |  320 |  141 |   78 |
| 0.35   | 1395 |  347 |  152 |   84 |
| 0.40   | 1472 |  366 |  161 |   89 |
| 0.45   | 1518 |  377 |  166 |   92 |
| 0.50   | 1533 |  381 |  167 |   93 |

::: voice-father
お父さん「たとえばなんだけどね。復職率を調べたいとするでしょ。そうすると復職率をどれくらい精確に推定できたかを表す指標が、95%信頼区間だよね。仮に復職率が50%だったとしてみよう。そうすると、50%±10%程度の推定精度がほしいよね。ここでいう±の後の数字が、95%信頼区間の幅になるんだ」
:::

::: voice-daughter
私「ああ、”50%（95%CI 40～60%）”みたいな感じで論文に書くことになるわけだ。40〜60%の場合、95%信頼区間幅は20%ってことね」
:::

::: voice-father
お父さん「そういうこと。表では復職率をπという変数で表しているんだけど、”π=0.5”と”信頼区間幅0.2”に対応する数字をみて。93って書いてあるでしょ。これが必要サンプルサイズ」
:::

::: voice-daughter
私「どうだろう。復職率ってもっと高くない？手術したときの年齢にもよるけど、たとえば患者さんが50歳前後だったら、80%はいってほしいなあ」
:::

::: voice-father
お父さん「そうなんだ。そうすると復職率80%は非復職率20%と同じことだから、”π=0.2”と”信頼区間幅0.2”のところをみればいい。サンプルサイズは60人」
:::

::: voice-daughter
私「100人で足りてるじゃん」
:::

::: voice-father
お父さん「いやいやいや、これは復職率の信頼区間からサンプルサイズを計算したからこうなったんだ。"信頼区間アプローチ"といって、主に探索的研究で使うものなんだよ。ストーマ造設ありとなしの復職率を比べるような仮説検証を目指した研究なら、"仮説検定アプローチ"といって、仮説検定の考え方にそってサンプルサイズを計算しないといけない」
:::

::: voice-daughter
私「そっか。だいたいわかった。私、明日も出勤だから、また今度教えてよ。おやすみー」
:::
:::::::::::::::::::::::::::::::::

::: {.callout-note title="サンプルサイズ設計の2つのアプローチ"}
研究計画を立てるときには、サンプルサイズを見積もる必要があります。サンプルサイズの計算は大まかにいえば2種類あって、信頼区間アプローチ（たとえば表1）と仮説検定アプローチ（次回）を用いることができます。

信頼区間アプローチは、調査や探索的研究で用いられます。このアプローチによって割合を推定するために必要なサンプルサイズを求めるとき、次の数値を設定する必要があります。

-   割合の真値（復職率など）
-   信頼区間幅

もうひとつの仮説検定アプローチは、臨床試験や仮説検証型の研究に適しています。このアプローチでは、以下の3つの要素が最低でも必要です。

-   有意水準（通常5%）
-   検出力（通常80～90%）
-   検出したい効果サイズ（2群間の生存確率の差やハザード比など）

サンプルサイズ設計は、βエラーを制御するという意味で、p値と対になる統計手法といえます。
:::

::: {.callout-note title="このエピソードに関係するクイズです"}

がん臨床試験では、治療からどの程度生存したかを表す指標として、生存期間中央値（median survival）を求めることがあります。これは生存時間データであるOSから計算される値です。さて、生存期間中央値を報告してよいのは、どのような場合でしょうか？

1.  半数以上の対象者がイベントを起こしたとき
2.  目安としてサンプルサイズが100人以上のとき
3.  すべての対象者が予定された追跡期間を完了したとき
4.  1、2、3すべて誤り
:::

::: {.callout-note collapse="true" title="答えはこちら"}
-   **正解は1です**

柔軟に考えてみましょう。生存期間は、日数や年数のような数値データですから、連続データに近い特徴を持っています。連続データでは、中央値（median）は上位50%に相当する値のことですよね。半数以上の対象者がイベントを起こして、生存期間が確定すれば、たとえ打ち切りがあっても、生存期間中央値を求めることができます。もし、予定された追跡期間を全員が完了したとしても、イベントがじゅうぶんに観察されなければ（つまり打ち切りが多かったら）、統計的なテクニックで中央値を計算することはできますが、バイアスが生じる可能性が高くなります。
:::

### 文献

- [Machin D, Campbell MJ, Tan SB, Tan SH. 医学のためのサンプルサイズ設計（原著第4版）. 京都: 京都大学学術出版会; 2022](https://www.kyoto-up.or.jp/9784814003822.html)

- Sasako M, Sano T, Yamamoto S, Sairenji M, Arai K, Kinoshita T, Nashimoto A, Hiratsuka M, Japan Clinical Oncology Group (JCOG9502). Left thoracoabdominal approach versus abdominal-transhiatal approach for gastric cancer of the cardia or subcardia: a randomised controlled trial. Lancet Oncol 2006;7(8):644-51

- [Green J, Benedetti J, Smith A, Crowley J. 米国SWOGに学ぶがん臨床試験の実践 第2版（原書第3版）. 東京: 医学書院; 2013](https://www.igaku-shoin.co.jp/book/detail/84805)

### Continuation of their story

[Study design I](study-design-1.qmd)

[Study design II](study-design-2.qmd)

[Study design III](study-design-3.qmd)

[Study design IV](study-design-4.qmd)

[Study design V](study-design-5.qmd)

[Frequentist thinking I](frequentist-1.qmd)

[Frequentist thinking II](frequentist-2.qmd)

[Frequentist thinking III](frequentist-3.qmd)

[Frequentist thinking IV](frequentist-4.qmd)

[Frequentist thinking V](frequentist-5.qmd)

[Effects and time I](effects-1.qmd)

[Effects and time II](effects-2.qmd)

[Effects and time III](effects-3.qmd)

[Effects and time IV](effects-4.qmd)

[Effects and time V](effects-5.qmd)

[Adjusting for bias I](logistic-regression-1.qmd)

[Adjusting for bias II](logistic-regression-2.qmd)

[Adjusting for bias III](logistic-regression-3.qmd)

[Adjusting for bias IV](logistic-regression-4.qmd)

[Causal inference I](causal-inference-1.qmd)

[Causal inference II](causal-inference-2.qmd)

[Causal inference III](causal-inference-3.qmd)

[Causal inference IV](causal-inference-4.qmd)

[The Craft of research I](publish-a-paper-1.qmd)

[The Craft of research II](publish-a-paper-2.qmd)

[The Craft of research III](publish-a-paper-3.qmd)

[The Craft of research IV](publish-a-paper-4.qmd)
