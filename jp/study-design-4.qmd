---
title: "A First Step into Survival and Competing Risks Analysis with R"
format:
  html:
    toc: true
---

```{=html}
<style>
header#title-block-header.quarto-title-block {
  display: none !important;
}

body {
  margin: 0;
  background: #ffffff;
  color: #2b1f1a;
  font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
  font-size: 18px;
  line-height: 1.55;
}

h1, h2, h3 {
  font-family: "Georgia", "Times New Roman", serif;
  color: #3a2a22;
  font-weight: 600;
}

h3 {
  margin-top: 2.4rem;
}

a {
  color: #8b4a24;
  text-decoration: none;
}
a:hover {
  color: #6f3718;
  text-decoration: underline;
}

.navbar {
  background: #ffffff !important;
  border-bottom: 1px solid #e6e0da;
  margin-bottom: 0 !important;
}
.navbar .navbar-brand,
.navbar .navbar-nav > li > a {
  color: #3a2a22 !important;
  border-bottom: 2px solid transparent;
  padding-bottom: 2px;
}
.navbar .navbar-nav > li > a:hover {
  border-bottom-color: #8b4a24;
}

.hero-text {
  padding: 1.5rem 0;
  color: #3a2a22;
}

.project-card {
  border: 1px solid #e6e0da;
  padding: 1.3rem 1.5rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  background: #ffffff;
  border-radius: 6px;
  margin-bottom: 1.5rem;
}

.about-section {
  border: 1px solid #e6e0da;
  padding: 1.5rem;
  border-radius: 0;
  background: #ffffff;
  margin-top: 2.5rem;
}

.about-section::after {
  content: "";
  display: block;
  clear: both;
}

.author-photo {
  float: left;
  margin-right: 1rem;
  border-radius: 50%;
}

.btn-link {
  display: inline-block;
  border: 1px solid #8b4a24;
  color: #8b4a24;
  padding: 0.4rem 0.9rem;
  font-size: 0.9rem;
  border-radius: 3px;
}
.btn-link:hover {
  background: #8b4a24;
  color: #ffffff;
}

.content-narrow {
  max-width: 1000px;
  margin: 0 auto;
  padding: 1.8rem 1.2rem 2.5rem;
}

.hero-header {
  margin-left: calc(50% - 50vw);
  margin-right: calc(50% - 50vw);
}

.hero-header-img {
  width: 100vw;
  height: min(400px, 45vh);
  object-fit: cover;
  object-position: 50% 40%;
  display: block;
}

.dialogue p {
  line-height: 1.7;
}
.dialogue .voice-father p {
  color: #7a3e1a !important;
}
.dialogue .voice-daughter p {
  color: #234f7c !important;
}
.dialogue .voice-daughter,
.dialogue .voice-father {
  margin-bottom: 0.4rem;
}

.text-right {
  text-align: right;
}
.serif-block p {
  font-family: "Georgia", "Times New Roman", serif;
  font-size: 0.9em;  line-height: 1.6;
}
</style>
```

::: {.hero-header}
![](../image/father-daughter.png){.hero-header-img}
:::

# Study Design IV − A First Step into Survival and Competing Risks Analysis with R

::: {.serif-block .text-right}
Keywords: bias, observational study, hypothesis/outcome/population, simulation, survival/competing-risk
:::

------------------------------------------------------------------------

### 調査項目とデータの型

::::::::::::::::::::::::::::::::: dialogue
::: voice-daughter
私「今、話しかけていいかな、お父さん。がんサバイバーの復職率を調査する話があったでしょ。患者さんに送る調査票をつくってみたんだけど、見てくれる？」
:::

::: voice-father
お父さん「どれどれ」
:::


![](study-design-4-1.png)


::: voice-father
お父さん「復職率の定義はなに？」
:::

::: voice-daughter
私「どういうこと？」
:::

::: voice-father
お父さん「調査票を見ただけじゃ、この質問項目で十分かどうかわからないってこと。手術日から調査日の間に、復職を希望した患者さんが、希望どおり復職できたかどうかを調べたいのかな？」
:::

::: voice-daughter
私「それもいいんだけど、復職を希望してないって回答した患者さんのなかに、会社の方針などの理由で復職をあきらめた患者さんも含まれるかもしれない。だから、復職率を計算するとき、分母は、復職を希望した患者さんじゃなくて、手術を受けた患者さん全員にしたいわ。そうした方が、就労実態がわかりやすそうだもの」
:::

::: voice-father
お父さん「手術日から調査日の間の復職を調べたいかどうかについては？」
:::

::: voice-daughter
私「えーっと。調査票に回答してもらうタイミングは患者さんによってまちまちになりそうだから、調査日は使いたくない。1年以内に復職できるかを定義にするのはどうかな？あ！ 復職日を答えてもらえばいいのかも！」
:::

::: voice-father
お父さん「復職日はあった方がいいよね。そうすると、復職状況から解析用の“変数”をつくるには、分類データと生存時間データの2通りが考えられる。それはさておき、手術後に亡くなった場合はどうするの？」
:::

::: voice-daughter
私「入院中に亡くなった場合は、調査対象に含めない。でも、術後再発による死亡を分母から除外するのは変な気がする」
:::

::: voice-father
お父さん「そうだね。除外するとバイアスが生じると思う。がん患者さんを追跡するような臨床研究では、大切なことが3つある。1つ、どのタイミングを**時間原点**にするかを決める必要があるよね。この場合、時間原点は退院日にするといい。2つ、追跡期間の目標を設定して、その時点までは、可能な限り情報を収集すること。 情報が取れないとバイアスが生じる原因になる。3つ、時間原点後に生じたイベントは除外してはならない」
:::
:::::::::::::::::::::::::::::::::

- 時間原点を定義する
- 追跡期間の目標を設定し、その時点までは可能な限り情報を収集する
- 時間原点後に生じたイベントは除外したり、層別に用いたりしない

::::::::::::::::::::::::::::::::: dialogue
::: voice-daughter
私「後からバイアスがあるとか言われたくないもんね。ふむふむ」
:::

::: voice-father
お父さん「以前、“PECO”という要素を使って臨床疑問を構造化したらってアドバイスしたよね。Pが根治切除後の直腸がん患者さんだったら、その集団をもれなく調査しないといけない」
:::

::: voice-daughter
私「分類データと生存時間データってなに？」
:::

::: voice-father
お父さん「これもこの前話したでしょ。統計解析を行ううえで基本になるのが“データの型”で、分類データと生存時間データはその種類だよ」
:::

::: voice-daughter
私「いや、先週の話だし、私忙しいし」
:::

::: voice-father
お父さん「調査票を少し手直ししたから、これを使ってもう一度話すよ」
:::

![](study-design-4-2.png)

::: voice-father
お父さん「分類データは、この場合、患者のアウトカムを分類したものだよ。1年以内に復職したかどうかをアウトカムにしたらどうかなっていってたよね」
:::

::: voice-daughter
私「うん」
:::

::: voice-father
お父さん「たとえば、“1年以内に復職あり”を分類1、“1年以内に復職なし”を分類2にしたら、2値データと呼ばれる分類データの一種になる。これは調査票から調べられるし、復職率も計算できるよね」
:::

::: voice-daughter
私「うん。1年以内の死亡を復職なしって扱えばね」
:::

::: voice-father
お父さん「でも就労状況を集計するときは2値データではなく、3カテゴリの分類データの方がいい。“1年以内に復職あり”を分類1、“1年以内に復職なし（死亡以外の理由のため）”を分類2、“1年以内に復職なし（死亡のため）”を分類3にしたらどう？もっと詳細にアウトカムが把握できるでしょ」
:::

::: voice-daughter
私「うんうん。じゃあ生存時間データはなんだっけ？OSってこと？」
:::

::: voice-father
お父さん「たしかに全生存期間（OS）は生存時間データの一種だよ。名前から誤解されがちだけど、それ以外にもあるんだ。生存時間データがどういうものかっていうと、時間原点から“イベント”までにかかった時間を表す変数のこと」
:::

::: voice-daughter
私「復職状況も生存時間データになるの？」
:::

::: voice-father
お父さん「そうすることもできる。この場合は、“退院日から復職日までの期間”を考えればいい。たとえばね、4月1日に退院して、4月30日に復職したとしたら、この患者の生存時間データは30-1+1=30日になる。これだとただの日数だから、連続データとの違いがはっきりしないけど、生存時間データの本質は、**打ち切り （censoring）**があることなんだ。調査日までに復職しなかった場合、退院日から復職日までの期間は存在しないでしょ」
:::

::: voice-daughter
私「まあそうだけど、それでいいんじゃないの？」
:::

::: voice-father
お父さん「統計解析のソフトウェアを使うとき一工夫が必要で、調査日の時点で復職しなかった、つまり復職の追跡が打ち切られたという情報を、入力してあげなければならない。だから生存時間データは、2つの変数が組になっているんだ。
:::
:::::::::::::::::::::::::::::::::

- 時間変数
- イベント変数

::::::::::::::::::::::::::::::::: dialogue
::: voice-father
お父さん「イベント変数は、いわゆる生存時間データの場合は、イベントが観察されたか、打ち切りになったかを表す2値データ。時間変数は、この場合は“退院日から復職日までの期間”か“退院日から調査日までの期間”のどちらかになる」
:::

::: {.callout-note appearance="simple"  title="生存時間データの入力"}

生存時間データは2つの変数の組であるため、Rの関数に入力するときもペアで指定する必要があります。**survival**パッケージの`survfit()`や`coxph()`では、実は入力専用の関数`Surv()`を用意しています。入力の仕様はパッケージによってまちまちで、たとえば**mets**パッケージでは`Event()`を別に定義して用いています。**cifmodeling**パッケージの`cifplot()`は、`Surv()`と`Event()`の両方に対応しています。

```{r surv_example, eval=FALSE}
library(survival)
library(cifmodeling)

survfit(Surv(time, status) ~ stoma,
  data         = dat
)
cifplot(Surv(time, status) ~ stoma,
  data         = dat,
  outcome.type = "survival",
  label.y      = "Overall survival"
)
cifplot(Event(time, status) ~ stoma,
  data         = dat,
  outcome.type = "survival",
  label.y      = "Overall survival"
)
```
:::

::: voice-daughter
私「えーっと、イベント変数は2値データってことは、すべての患者さんで復職か、打ち切りかの2択しかないってこと？死亡はどうなるの？」
:::

::: voice-father
お父さん「いま話したような扱いをするなら、死亡した患者さんは、打ち切りという分類に含まれることになる。ただし、**競合リスク （competing risk）**という別の扱い方もある。簡単にいうと、それが起こると研究で調べたいイベント（たとえば死亡や復職）が観察されなくなる、競合するイベントのことだよ」
:::

::: voice-daughter
私「ああ、死亡が競合リスクってことね」
:::

::: voice-father
お父さん「生存時間データは、英語ではsurvival data以外にtime-to-event dataっていったりもするんだけどね。時間とともに起きるイベントって、生存か死亡かだけじゃないでしょ。競合リスクを解析できるようにしたのが競合リスクモデルなんだ。この場合、さっきのイベント変数は、イベント、競合リスク、打ち切りという3カテゴリを表す変数になる。イベント変数はこんな感じでコーディングされる」
:::

- イベント変数=0: イベントが観察される前に打ち切りになった
- イベント変数=1: イベントが観察された
- イベント変数=2: イベントが観察される前に競合リスクが生じた

::: voice-daughter
私「だいたいわかった。この調査票、使わせてもらうね」
:::
::::::::::::::::::::::::::::::::: 


### 生存時間解析と競合リスク解析

::: {.callout-note appearance="simple" title="シミュレーションデータ（再発あり）の生成"}
前回より少しだけがんの臨床研究を意識して、シミュレーションデータにおける、全生存期間（OS）・無再発生存期間（RFS）・累積再発率（CIR）の違いをみてみましょう。CIRの解析では、再発の前に死亡した患者が存在するため、その扱いを決める必要があります。これを**競合リスク（competing risk）**といいます。

以下のコードでは、死亡だけではなく再発を伴った生存時間アウトカム3種類をRで生成する「関数」`generate_data()`を定義しています。OSのイベントは「死亡」、RFSのイベントは「死亡と再発」です。CIRのイベントは「再発」ですが、死亡を競合リスクとして扱います。なお、`generate_data()`やこのシミュレーションデータは、今後の解説でも再利用する予定です。

-   ストーマ保有：2項分布（`rbinom`）から生成した2値データ

-   生存時間：指数分布（`rexp`）から生成した生存時間データ（t_relapse, t_death, t_censoringの乱数から計算）

前回、競合リスクのない生存時間データを要約しましたが、そこで用いたのは**Kaplan-Meier曲線**でしたよね。それに対して、競合リスク解析では、Kaplan-Meier曲線ではなく、**Aalen-Johansen曲線**を用いるのが正式です。
:::

::: {.callout-note appearance="simple"  collapse="true" title="generate_data()のコードはこちら（データ生成に使用）"}
```{r warning=FALSE}
generate_data <- function(n=200, hr1, hr2) {
  stoma <- rbinom(n, size = 1, prob = 0.4)
  sex <- rbinom(n, size = 1, prob = 0.5)
  age <- rnorm(n, mean = 65 + 3 * stoma, sd = 8)
  hazard_relapse   <- ifelse(stoma == 1, hr1*0.10, 0.10) # 再発のハザード（大きいほど早く起こる）
  hazard_death     <- ifelse(stoma == 1, hr2*0.10, 0.10) # 死亡のハザード（大きいほど早く起こる）
  hazard_censoring <- 0.05                               # 打ち切りハザード（群に依存しない）
  
  t_relapse   <- rexp(n, rate = hazard_relapse)   # 再発までの潜在時間
  t_death     <- rexp(n, rate = hazard_death)     # 死亡までの潜在時間
  t_censoring <- rexp(n, rate = hazard_censoring) # 打ち切りまでの潜在時間
  
  ## --- 全生存期間（OS） ----------------------------------------
  time_os   <- pmin(t_death, t_censoring)
  status_os <- as.integer(t_death <= t_censoring)  # 1 = 死亡, 0 = 打ち切り
  
  ## --- 無再発存期間（RFS） -------------------------------------
  time_rfs <- pmin(t_relapse, t_death, t_censoring)
  
  status_rfs <- integer(n)
  status_rfs[time_rfs == t_relapse & time_rfs < t_censoring] <- 1 # 再発
  status_rfs[time_rfs == t_death & time_rfs < t_censoring] <- 1   # 死亡
  
  ## --- 累積再発率（CIR） + 競合リスク --------------------------
  time_cir <- pmin(t_relapse, t_death, t_censoring)
  
  status_cir <- integer(n)
  status_cir[time_cir == t_relapse & time_cir < t_censoring] <- 1 # イベント1: 再発
  status_cir[time_cir == t_death & time_cir < t_censoring] <- 2   # イベント2: 競合リスクとしての死亡
  
  ## --- データフレームにまとめる --------------------------------
  dat <- data.frame(
    id         = 1:n,
    sex        = factor(sex, levels = c(0, 1), labels = c("WOMAN", "MAN")),
    age        = age,
    stoma      = factor(stoma, levels = c(0, 1),
                        labels = c("WITHOUT STOMA", "WITH STOMA")),
    time_os    = time_os,
    status_os  = status_os,
    time_rfs   = time_rfs,
    status_rfs = status_rfs,
    time_cir   = time_cir,
    status_cir = status_cir
  )
  return(dat)
}
```
:::


::: {.callout-note appearance="simple"  title="全生存期間（OS）のKaplan–Meier曲線"}
OSとRFSは通常の生存時間データですから、前回と同様に**cifmodeling**パッケージの`cifplot()`を使って、Kaplan–Meier曲線で記述します。まずはOS。
:::

::: {.callout-note appearance="simple" collapse="true" title="Rコードと結果はこちら"}
```{r warning=FALSE}
# devtools::install_github("gestimation/cifmodeling") #インストールが必要なら実行 
library(cifmodeling)
set.seed(46)
dat <- generate_data(hr1=2, hr2=1.5) #再発ハザード比2, 死亡ハザード比1.5のデータ生成

cifplot(Event(time_os, status_os) ~ stoma,
  data         = dat,
  outcome.type = "survival",
  label.y      = "Overall survival"
)
```
:::

::: {.callout-note appearance="simple"  title="無再発生存期間（RFS）のKaplan–Meier曲線"}
次にRFSです。`Event()`で指定する変数以外は変わりません。
:::

::: {.callout-note appearance="simple" collapse="true" title="Rコードと結果はこちら"}
```{r}
cifplot(Event(time_rfs, status_rfs) ~ stoma,
  data         = dat,
  outcome.type = "survival",
  label.y      = "Relapse-free survival"
)
```
:::

::: {.callout-note appearance="simple"  title="累積再発率（CIR）のAalen-Johansen曲線"}
以下のコードでは、`Event(time_cir, status_cir)`のコーディングによって競合リスクを入力しています。

- `status_cir=1` : 関心のあるイベント（再発）
- `status_cir=2` : 競合リスク（再発を経験しない死亡）
- `status_cir=0` : 打ち切り

さらに`outcome.type = "competing-risk"`を指定することで、Aalen-Johansen曲線を描いています。
:::

::: {.callout-note appearance="simple" collapse="true" title="Rコードと結果はこちら"}
```{r}
cifplot(Event(time_cir, status_cir) ~ stoma,
  data         = dat,
  outcome.type = "competing-risk",
  label.y      = "Cumulative incidence of relapse"
)
```
:::

::::::::::::::::::::::::::::::::: dialogue
::: voice-daughter
私「Aalen-Johansen曲線って、Kaplan–Meier曲線のY軸を逆さにしただけじゃないの」
:::

::: voice-father
お父さん「グラフ上は見分けられないからそう思っても仕方ないよね。でもこのふたつは区別してほしい。

> 生存曲線（Kaplan–Meier曲線）と累積発生曲線（Aalen-Johansen曲線）は別の統計手法なので
> 競合リスクがあるときはAalen-Johansen曲線を用いる。

ちなみに、relapse-free timeじゃなくてcumulative incidence of relapseを使いたいっていったけど、それは**累積発生曲線（cumulative incidence curve）**が、専門的にはAalen-Johansen曲線と同じ意味だからなんだよね。やろうと思えばCIRを解析するとき、Kaplan–Meier曲線を計算することもできるよ。このとき、再発を経験しない死亡は、競合リスク（`status_cir=2`）ではなく打ち切り（`status_cir=0`）として入力することになる。でも本来なら、死亡は、追跡期間終了や追跡不能による打ち切りとは、違う転帰だよね。だから競合リスクとして扱うのが正しい。
:::

::: voice-daughter
私「じゃあ死亡と再発を両方イベントにしたRFSを解析するのは間違い？」
:::

::: voice-father
お父さん「もちろん間違いじゃないよ。でも、RFS曲線の差は、再発だけでなく他因死の影響も反映しているよね。だから、さっきいったみたいに、OS、RFS、CIRは使い分けが必要になる」
:::
::::::::::::::::::::::::::::::::: 

::: {.callout-note appearance="simple" title="このエピソードに関係するクイズです"}

Kaplan-Meier法による生存曲線の推定が妥当な状況として正しいのは、次のうちどれでしょうか。

1.  生存時間が正規分布するとき
2.  打ち切りの理由が疾患の悪化によらないとき
3.  2群の打ち切り確率に統計学的な有意差がなかったとき
4.  試験治療群とコントロール群の間で比例ハザード性が成り立つとき
:::

::: {.callout-note appearance="simple" collapse="true" title="答えはこちら"}
- **正解は2です**

Kaplan-Meier法では、生存時間が正規分布したり、比例ハザードが成り立ったりする必要はありません（これはそれぞれ*t*検定とCox回帰の前提条件ですね）。疾患の悪化に伴って、試験の途中で患者が追跡できなくなると、推定された生存曲線にバイアスが生じてしまいます。2群の生存曲線を比べるとき、それぞれの群の打ち切り確率を比較することがあります。有意差があればバイアスがあるといえますが、たとえばサンプルサイズが小さいときは有意差が出ませんから、Kaplan-Meier法が妥当という証拠にはなりません。逆にいうと、打ち切りがランダムに起きていることが、Kaplan-Meier法の基本的な前提条件です。
:::

### エピソードとRスクリプト

- [A Story of Coffee Chat and Research Hypothesis](study-design-1.html)
- [Data Have Types: A Coffee-Chat Guide to R Functions for Common Outcomes](study-design-2.html)
- [Outcomes: The Bridge from Data Collection to Analysis](study-design-3.html)
- [A First Step into Survival and Competing Risks Analysis with R](study-design-4.html)
- [When Bias Creeps In: Selection, Information, and Confounding in Clinical Surveys]

- [study-design.R](../from-coffee-chat-to-r/study-design.R)